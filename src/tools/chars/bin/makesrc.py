import json
import glob
import argparse
import os
import binascii
import subprocess
import platform

def chunks(l, n):
    for i in range(0, len(l), n):
        yield l[i:i+n]

CHUNK_SIZE = 16

FN = '''
const uint8_t * getCustomChars() {
    return custom_chars_data;
}
'''

GPL3 = '''
/*
    cs3-runtime-sdl
    Copyright (C) 2024  Francois Blanchette

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
'''




def main():
    OUT_H = 'out/chars.h'
    with open(OUT_H, 'w') as tfile:
        tfile.write(GPL3.strip() + '\n')
        tfile.write("// autogenerated\n\n")
        tfile.write('#include <cstdint>\n')
        tfile.write('#pragma once\n')
        tfile.write('const uint8_t * getCustomChars();\n\n')
        i = 128

        name ='CUSTOM'
        tfile.write(f'#define CHARS_{name:16} {hex(i)}\n')
        with open('inputs/chars.ini') as sfile:
            data = sfile.read()
            for line in data.split():
                name = line.strip().upper()
                if name:
                    tfile.write(f'#define CHARS_{name:16} {hex(i)}\n')
                i +=1
        print(f'exported {OUT_H}')


    with open('out/chars.bin', 'rb') as sfile:
        data = sfile.read()

    OUT_CPP = 'out/chars.cpp'
    with open(OUT_CPP, 'w') as tfile:
        tfile.write(GPL3.strip() + '\n')
        tfile.write("// autogenerated\n\n")
        tfile.write('#include "chars.h"\n')
        tfile.write('const uint8_t custom_chars_data[]={\n' )
        for line in chunks(binascii.b2a_hex(data), CHUNK_SIZE):
            tfile.write('    ' + ','.join(['0x'+ch.decode("utf-8") for ch in chunks(line, 2)]))
            if len(line) == CHUNK_SIZE:
                tfile.write(',')
            tfile.write('\n')
        tfile.write('};\n')
        tfile.write(FN)
        print(f'exported {OUT_CPP}')

main()
